(function(){
  try{
    var d=document,w=window;
    var currentScript=d.currentScript||function(){var s=d.getElementsByTagName('script');return s[s.length-1]}();
    var DEFAULTS={
      width:380,
      height:600,
      right:24,
      bottom:24,
      bubbleColor:'#1C64F2',
      iframePath:'/',
      allow:'clipboard-write *; microphone; camera',
      title:'智能体助手'
    };
    function getOriginFromUrl(u){try{var a=d.createElement('a');a.href=u;return a.protocol+'//'+a.host}catch(e){try{var url=new URL(u);return url.origin}catch(_){return ''}}}
    function getConfig(){
      var cfg=w.adpChatbotConfig||{};
      // derive baseUrl from script src by default
      var src=currentScript&&currentScript.src||'';
      var origin=getOriginFromUrl(src);
      var baseUrl=cfg.baseUrl||origin||'';
      return {
        baseUrl:baseUrl,
        width:cfg.width||DEFAULTS.width,
        height:cfg.height||DEFAULTS.height,
        right:cfg.right||DEFAULTS.right,
        bottom:cfg.bottom||DEFAULTS.bottom,
        bubbleColor:cfg.bubbleColor||DEFAULTS.bubbleColor,
        iframePath:cfg.iframePath||DEFAULTS.iframePath,
        allow:cfg.allow||DEFAULTS.allow,
        title:cfg.title||DEFAULTS.title
      };
    }
    function css(el, styles){for(var k in styles){if(Object.prototype.hasOwnProperty.call(styles,k)){el.style[k]=String(styles[k])}}}
    function createBubble(color, config){
      var b=d.createElement('div');
      b.setAttribute('data-adp-chatbot','bubble');
      css(b,{
        position:'fixed',right:config.right+'px',bottom:config.bottom+'px',
        width:'56px',height:'56px',borderRadius:'50%',
        background:color,color:'#fff',display:'flex',alignItems:'center',justifyContent:'center',
        boxShadow:'0 8px 24px rgba(0,0,0,.18)',cursor:'pointer',zIndex:2147483647,userSelect:'none'
      });
      b.innerHTML='<svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M20 12c0 3.866-3.582 7-8 7-1.004 0-1.96-.166-2.833-.468L4 20l1.54-3.08C5.197 16.04 5 14.98 5 14c0-3.866 3.582-7 8-7s7 3.134 7 7z" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      return b;
    }
    function createWrap(config){
      var wv=d.createElement('div');
      wv.setAttribute('data-adp-chatbot','wrap');
      css(wv,{
        position:'fixed',right:config.right+'px',bottom:config.bottom+'px',
        width:config.width+'px',height:config.height+'px',
        border:'1px solid #e5e7eb',borderRadius:'12px',boxShadow:'0 10px 30px rgba(0,0,0,.15)',
        background:'#fff',overflow:'hidden',zIndex:2147483647,display:'none'
      });
      var bar=d.createElement('div');
      css(bar,{
        position:'absolute',top:'0',left:'0',right:'0',height:'40px',background:'#fff',
        borderBottom:'1px solid #eef2f7',display:'flex',alignItems:'center',justifyContent:'space-between',
        padding:'0 10px 0 12px',fontSize:'14px',color:'#111827',zIndex:1
      });
      bar.innerHTML='<div>'+escapeHtml(config.title)+'</div>';
      var actions=d.createElement('div');css(actions,{display:'flex',gap:'6px',alignItems:'center'});
      var minimize=iconBtn('—','最小化');
      actions.appendChild(minimize);
      bar.appendChild(actions);
      var ifr=d.createElement('iframe');
      ifr.setAttribute('data-adp-chatbot','iframe');
      ifr.src=(config.baseUrl||'')+config.iframePath;
      ifr.setAttribute('allow',config.allow);
      css(ifr,{position:'absolute',top:'40px',left:'0',width:'100%',height:'calc(100% - 40px)',border:'0',background:'#fff'});
      wv.appendChild(bar);wv.appendChild(ifr);
      return {wrap:wv, minimize:minimize, iframe:ifr};
    }
    function iconBtn(text,title){var b=d.createElement('button');b.setAttribute('type','button');b.title=title;css(b,{width:'28px',height:'28px',borderRadius:'6px',border:'1px solid #e5e7eb',background:'#fff',display:'inline-flex',alignItems:'center',justifyContent:'center',cursor:'pointer'});b.textContent=text; b.onmouseover=function(){b.style.background='#f7f8fa'}; b.onmouseout=function(){b.style.background='#fff'};return b}
    function escapeHtml(s){return String(s).replace(/[&<>"]/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[c]})}

    var cfg=getConfig();
    var KEY='adp_embed_open_'+(cfg.baseUrl||'');

    // Avoid duplicate
    if(d.querySelector('[data-adp-chatbot="bubble"]')||d.querySelector('[data-adp-chatbot="wrap"]')) return;

    var bubble=createBubble(cfg.bubbleColor, cfg);
    var parts=createWrap(cfg);
    var wrap=parts.wrap, minimize=parts.minimize;

    function open(){wrap.style.display='block';bubble.style.display='none'; try{localStorage.setItem(KEY,'1')}catch(e){} }
    function close(){wrap.style.display='none';bubble.style.display='flex'; try{localStorage.setItem(KEY,'0')}catch(e){} }
    function toggle(){ if(wrap.style.display==='none'||wrap.style.display===''){open()} else {close()} }

    bubble.addEventListener('click', open);
    minimize.addEventListener('click', close);

    // initial state
    var saved=''; try{saved=localStorage.getItem(KEY)||''}catch(e){}
    if(saved==='1'){open()} else {close()}

    d.body.appendChild(bubble);
    d.body.appendChild(wrap);

    w.ADPChatbot={open:open,close:close,toggle:toggle,version:'1.0.0'};
  }catch(err){/* swallow */}
})();
